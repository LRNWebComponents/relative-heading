<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="relative-heading-manager.html">

<!--
`relative-heading`
A LRN element

@demo demo/index.html

@microcopy - the mental model for this element
 -
 -
 -

-->

<dom-module id="relative-heading">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
    <div id="html"></div>
  </template>

  <script>
    Polymer({

      is: 'relative-heading',

      properties: {
        /* 
         * id of the heading element that this heading is a subtopic of 
         */
        subtopicOf: {
          type: String,
          value: null,
          reflectToAttribute: true
        },
        /* 
         * text of the heading 
         */
        text: {
          type: String,
          value: null,
          reflectToAttribute: true
        },
        /* 
         * the heading element that this heading is a subtopic of 
         */
        parentHeading: {
          type: Object,
          value: {}
        },
        /* 
         * the heading tag, eg. <h1/>, <h2/> ...
         */
        tag: {
          type: Number,
          value: null,
          computed: '_getTag(parentHeading)',
          reflectToAttribute: true
        },
        /* 
         * the html output 
         */
        html: {
          type: String,
          computed: '_getHtml(tag)',
        },
      },
      created: function(){
        Polymer.RelativeHeadingManager.requestAvailability();
      },
      attached: function(){
        let root = this;
        this.fire('heading-created',this);
      },
      _setParent: function(el){
        let root = this;
        if (this.__parentListener !== undefined) root.parentHeading.removeEventListener('heading-changed');
        root.parentHeading = el;
        if (el !== null) {
          this.__parentListener = root.parentHeading.addEventListener('heading-changed', function(e){
            root.parentHeading = null;
            root.parentHeading = el;
          });
        }
      },
      _setLevel: function(level){
        return Math.max(Math.min(level,6),1);
      },
      _getTag: function(){
        let level = 1;
        if(this.parentHeading !== null) {
          if (this.parentHeading.tag !== undefined) {
            level = parseInt(this.parentHeading.tag.replace('h',''))+1;
          } else if (this.parentHeading.tagName !== undefined && this.parentHeading.tagName.match(/^H[0-6]$/)) {
            level = parseInt(this.parentHeading.tagName.replace('H','')) + 1;
          }
        }
        return 'h'+this._setLevel(level);
      },
      _getHtml: function(tag){
        this.fire('heading-changed',this);
        this.innerHTML = '<'+tag+'>'+this.text+'</'+tag+'>';
        return '<'+tag+'>'+this.text+'</'+tag+'>';
      },
      attributeChanged: function(subtopicOf){
        this.fire('heading-created',this);
      },
    });
  </script>
</dom-module>
