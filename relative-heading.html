<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../juicy-html/juicy-html.html">
<link rel="import" href="relative-heading-manager.html">

<!--
`relative-heading`
A LRN element

@demo demo/index.html

@microcopy - the mental model for this element
 -
 -
 -

-->

<dom-module id="relative-heading">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
   <juicy-html html="[[html]]"></juicy-html>
  </template>

  <script>
    Polymer({

      is: 'relative-heading',

      properties: {
        subtopicOf: {
          type: String,
          value: null,
          reflectToAttribute: true
        },
        text: {
          type: String,
          value: null,
          reflectToAttribute: true
        },
        parentHeading: {
          type: Object,
          value: {}
        },
        level: {
          type: Number,
          value: null,
          reflectToAttribute: true
        },
        html: {
          type: String,
          computed: '_getHtml(level)',
        },
      },
      created: function(){
        Polymer.RelativeHeadingManager.requestAvailability();
      },
      attached: function(){
        let root = this;
        this.fire('heading-created',this);
      },
      _setParent: function(el){
        let root = this;
        if (this.__parentListener !== undefined) root.parentHeading.removeEventListener('heading-changed');
        root.parentHeading = el;
        if (el !== null) {
          this.__parentListener = root.parentHeading.addEventListener('heading-changed', function(e){
            root._updateLevel();
          });
        }
        root._updateLevel();
      },
      _setLevel: function(level){
        this.level = Math.max(Math.min(level,6),1);
      },
      _updateLevel: function(){
        let level = 1
        if(this.parentHeading !== null) {
          if (this.parentHeading.level !== undefined) {
            level = this.parentHeading.level+1;
          } else if (this.parentHeading.tagName !== undefined && this.parentHeading.tagName.match(/^H[0-6]$/)) {
            level = parseInt(this.parentHeading.tagName.replace('H','')) + 1;
          }
        }
        this._setLevel(level);
      },
      _getHtml: function(level){
        this.fire('heading-changed',this);
        return '<h'+level+'>'+this.text+'</h'+level+'>';
      },
      attributeChanged: function(subtopicOf){
        this.fire('heading-created',this);
      },
    });
  </script>
</dom-module>
